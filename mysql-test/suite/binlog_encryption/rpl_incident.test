#
# The test is a combination of rpl.rpl_incident and binlog.binlog_incident
# tests, with some modifications in each
#

--source include/master-slave.inc
--source include/have_debug.inc

--enable_connect_log

RESET MASTER;

--let $binlog_start_pos= query_get_value(SHOW MASTER STATUS,Position,1)
--let $binlog_file= query_get_value(SHOW MASTER STATUS,File,1)

CREATE TABLE t1 (a INT);

INSERT INTO t1 VALUES (1),(2),(3);
SELECT * FROM t1;

let $debug_save= `SELECT @@GLOBAL.debug`;
SET GLOBAL debug_dbug= '+d,incident_database_resync_on_replace,*';

# This will generate an incident log event and store it in the binary
# log before the replace statement.
REPLACE INTO t1 VALUES (4);
--save_master_pos
SELECT * FROM t1;

--disable_query_log
eval SET GLOBAL debug_dbug= '$debug_save';
--enable_query_log

connection slave;
# Wait until SQL thread stops with error LOST_EVENT on master
call mtr.add_suppression("Slave SQL.*The incident LOST_EVENTS occurred on the master.* 1590");
let $slave_sql_errno= 1590;
let $show_slave_sql_error= 1;
--disable_query_log
source include/wait_for_slave_sql_error.inc;
--enable_query_log

# The 4 should not be inserted into the table, since the incident log
# event should have stop the slave.
SELECT * FROM t1;

SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1;
START SLAVE;
--sync_with_master

# Now, we should have inserted the row into the table and the slave
# should be running. We should also have rotated to a new binary log.

SELECT * FROM t1;

connection master;

DROP TABLE t1;
FLUSH LOGS;

exec $MYSQL_BINLOG --read-from-remote-server --port=$MASTER_MYPORT --protocol=tcp -uroot --start-position=$binlog_start_pos $binlog_file >$MYSQLTEST_VARDIR/tmp/binlog_incident.sql;
--disable_query_log
eval SELECT cont LIKE '%RELOAD DATABASE; # Shall generate syntax error%' AS `Contain RELOAD DATABASE` FROM (SELECT load_file('$MYSQLTEST_VARDIR/tmp/binlog_incident.sql') AS cont) AS tbl;
--enable_query_log

remove_file $MYSQLTEST_VARDIR/tmp/binlog_incident.sql;

--sync_slave_with_master

--disable_connect_log

--source include/rpl_end.inc
